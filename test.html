<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Pyscript CSV to Plot</title>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

    <!-- Include Pandas -->
    <py-config>
      packages = ["pandas"]
    </py-config>
  </head>

  <body>
    <h1>Pyscript: Code for Converting Whole Rock Analysis</h1>

    <!-- Input fields for user-defined values -->
    <label for="Fe3prop">Fe3prop:</label>
    <input type="number" id="Fe3prop" value="0.1" step="0.01"><br><br>

    <label for="watermol">Water Molecule %:</label>
    <input type="number" id="watermol" value="10" step="1"><br><br>

    <label for="apt">Apt (yes or no):</label>
    <input type="text" id="apt" value="yes"><br><br>

    <!-- Button to run the analysis -->
    <button id="runScript">Run Analysis</button>
    
    <pre id="output"></pre>

    <py-script>
        import pandas as pd
        from pyscript import Element

        # Function to run the analysis using input values
        def run_analysis(event=None):
            # Get values from input fields
            Fe3prop = float(Element("Fe3prop").value)
            watermol = float(Element("watermol").value)
            apt = Element("apt").value.lower()

            sample = "DLT01"
            dataset = pd.DataFrame({
                'SiO2': [60.41], 'TiO2': [0.93], 'Al2O3': [20.1], 'Fe2O3': [0], 'FeO': [5.68],
                'MnO': [0.08], 'MgO': [2.3], 'CaO': [1.06], 'Na2O': [1.53], 'K2O': [4.17], 'P2O5': [0.15], 'H2O': [0]
            })

            Moloxide = pd.DataFrame({
                'SiO2': [60.09], 'TiO2': [79.9], 'Al2O3': [101.94], 'Fe2O3': [159.69], 'FeO': [71.85],
                'MnO': [70.94], 'MgO': [40.3], 'CaO': [56.08], 'Na2O': [61.98], 'K2O': [94.2], 'P2O5': [141.94], 'H2O': [18.02]
            })

            oxidepp = dataset / Moloxide

            Fecorr = oxidepp.copy()
            Fecorr['Fe2O3'] = Fe3prop * (oxidepp['Fe2O3'] + 0.5 * oxidepp['FeO'])

            Aptcorr = Fecorr.copy()
            if apt == "yes":
                Aptcorr['CaO'] -= 10 / 3 * Fecorr['P2O5']

            Aptcorr = Aptcorr.drop(columns=['P2O5', 'H2O'])
            Aptcorr['SUM'] = Aptcorr.sum(axis=1)

            MolPerc = Aptcorr.div(Aptcorr['SUM'], axis=0) * 100

            MolF = MolPerc.div(MolPerc['SUM'] + (2 * MolPerc['Fe2O3']), axis=0) * 100
            MolF.rename(columns={'Fe2O3': 'O2'}, inplace=True)
            MolF = MolF.drop(columns=['SUM'])

            TC = MolF * (1 - watermol / 100)

            CationsO2 = pd.DataFrame({
                'SI': TC['SiO2'], 'TI': TC['TiO2'], 'AL': TC['Al2O3'] * 2, 'FE': TC['FeO'], 'MN': TC['MnO'],
                'MG': TC['MgO'], 'CA': TC['CaO'], 'NA': TC['Na2O'], 'K': TC['K2O'] * 2, 'H': [watermol * 2], 'O': TC['O2']
            })

            CationsF3 = pd.DataFrame({
                'SI': TC['SiO2'], 'TI': TC['TiO2'], 'AL': TC['Al2O3'] * 2, 'FE': TC['FeO'], 'F3': TC['O2'] * 2, 'MN': TC['MnO'],
                'MG': TC['MgO'], 'CA': TC['CaO'], 'NA': TC['Na2O'], 'K': TC['K2O'] * 2, 'H': [watermol * 2]
            })

            ds62 = " ".join([f"{col}({CationsO2[col].iloc[0]:.3f})" for col in CationsO2.columns])
            ds55 = " ".join([f"{col}({CationsF3[col].iloc[0]:.3f})" for col in CationsF3.columns])

            result = (
                f"0   {ds62} O(?)    * {sample} Fe3/Fe2 = {Fe3prop} | H2O= {watermol} [ds62]\n"
                f"0   {ds55} O(?)    * {sample} Fe3/Fe2 = {Fe3prop} | H2O= {watermol} [ds55]"
            )

            Element("output").write(result)

        # Bind the button click to the run_analysis function
        Element("runScript").element.onclick = run_analysis
    </py-script>
  </body>
</html>
